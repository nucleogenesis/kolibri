<template>

  <div class="select-resource">
    <h5
      class="title-style"
    >
      <KRouterLink
        :to="goBack"
      >
        <KIcon
          icon="back"
        />
      </KRouterLink>
      {{ selectFoldersOrExercises$() }}
    </h5>

    <div v-if="!isTopicIdSet">

      <p>{{ selectFromBookmarks$() }}</p>

      <div @click="lessonCardClicked">
        <KRouterLink
          v-if="bookmarks"
          :appearanceOverrides="{
            width: '100%',
            textDecoration: 'none',
            color: $themeTokens.text
          }"
          :to="getBookmarksLink"
        >
          <div :class="windowIsSmall ? 'mobile-bookmark-container' : 'bookmark-container'">
            <BookmarkIcon :class="windowIsSmall ? 'mobile-bookmark-icon' : ''" />
            <div :class="windowIsSmall ? 'mobile-text' : 'text'">
              <h3>{{ coreString('bookmarksLabel') }}</h3>
              <p>{{ numberOfSelectedBookmarks$({ count: bookmarks.length }) }}</p>
            </div>
          </div>
        </KRouterLink>
      </div>

    </div>

    <ResourceSelectionBreadcrumbs
      v-if="isTopicIdSet"
      :ancestors="[]"
      :channelsLink="channelsLink"
      :topicsLink="topicsLink"
    />

    <ContentCardList
      v-if="visibleResources && visibleResources.length"
      :contentList="visibleResources"
      :showSelectAll="selectAllIsVisible"
      :viewMoreButtonState="'disabled'"
      :selectAllChecked="addableContent.length === 0"
      :contentIsChecked="contentIsInLesson"
      :contentHasCheckbox="c => !contentIsDirectoryKind(c)"
      :contentCardMessage="selectionMetadata"
      :contentCardLink="contentLink"
      @changeselectall="toggleTopicInWorkingResources"
      @change_content_card="toggleSelected"
      @moreresults="() => null"
    />
    <div class="bottom-navigation">
      <KGrid>
        <KGridItem
          :layout12="{ span: 6 }"
          :layout8="{ span: 4 }"
          :layout4="{ span: 2 }"
        >
          {{ numberOfResources$({ count: channels.length }) }}
        </KGridItem>
        <KGridItem
          :layout12="{ span: 6 }"
          :layout8="{ span: 4 }"
          :layout4="{ span: 2 }"
        >
          <!-- FIXME Don't always make this disabled -->
          <KButton
            :text="coreString('continueAction')"
            :primary="true"
            :disabled="false"
          />
        </KGridItem>
      </KGrid>
    </div>
  </div>

</template>


<script>

  import router from 'kolibri.coreVue.router';
  import { ref, onMounted } from 'kolibri.lib.vueCompositionApi';
  import vue from 'vue-router';
  import { enhancedQuizManagementStrings } from 'kolibri-common/strings/enhancedQuizManagementStrings';
  import every from 'lodash/every';
  import commonCoreStrings from 'kolibri.coreVue.mixins.commonCoreStrings';
  import pickBy from 'lodash/pickBy';
  import useKResponsiveWindow from 'kolibri-design-system/lib/useKResponsiveWindow';
  import { LessonsPageNames } from '../../../constants/lessonsConstants';
  import { PageNames } from '../../../constants';
  import BookmarkIcon from '../LessonResourceSelectionPage/LessonContentCard/BookmarkIcon.vue';
  import { useExerciseResources } from './../../../composables/useExerciseResources';
  import LessonsSearchBox from './../LessonResourceSelectionPage/SearchTools/LessonsSearchBox.vue';
  import ContentCardList from './../LessonResourceSelectionPage/ContentCardList.vue';
  //import LessonContentCard from './../LessonResourceSelectionPage/LessonContentCard/index.vue';
  //import LessonsSearchFilters from './../LessonResourceSelectionPage/
  // SearchTools/LessonsSearchFilters';
  import ResourceSelectionBreadcrumbs from './../LessonResourceSelectionPage/SearchTools/ResourceSelectionBreadcrumbs.vue';

  export default {
    name: 'ResourceSelection',
    components: {
      LessonsSearchBox,
      // BookMarkedResource,
      ContentCardList,
      BookmarkIcon,
      // ResourceSelection,
      ResourceSelectionBreadcrumbs,
      // LessonContentCard,
      // LessonsSearchFilters,
    },
    inject: ['quizForge'],
    mixins: [commonCoreStrings],
    setup() {

      const channels = ref([]);
      const visibleResources = ref([]);
      const bookmarks = ref([]);

      const {
        sectionSettings$,
        selectFromBookmarks$,
        numberOfSelectedBookmarks$,
        selectFoldersOrExercises$,
        numberOfSelectedResources$,
        numberOfResources$,
      } = enhancedQuizManagementStrings;

      const {
        fetchChannelsWithExercises,
        fetchBookmarksWithExercises,
        fetchTopicResources,
      } = useExerciseResources();


      onMounted(() => {
        const currentRoute = router._vueRouter.currentRoute;
        console.log(currentRoute);
        if(currentRoute.params.topic_id) {
          fetchTopicResources(currentRoute.params.topic_id).then(resource => {
            console.log('fetchedTopicResources', resource);
            visibleResources.value = resource.contentList;
            //this.ancestors = resource.ancestors;
          });
        }

        fetchChannelsWithExercises().then(c => {
          channels.value = c;
          if(!currentRoute.params.topic_id) {
            visibleResources.value = c;
          }
        });

        fetchBookmarksWithExercises().then(b => {
          bookmarks.value = b;
        });
      });

      const { windowIsSmall } = useKResponsiveWindow();

      return {
        sectionSettings$,
        selectFromBookmarks$,
        numberOfSelectedBookmarks$,
        selectFoldersOrExercises$,
        numberOfSelectedResources$,
        numberOfResources$,
        windowIsSmall,

        fetchTopicResources,
        bookmarks,
        channels,
        visibleResources,
      };
    },
    computed: {
      isTopicIdSet() {
        return this.$route.params.topic_id;
      },
      selectAllIsVisible() {
        return !every(this.quizForge.channels.value, this.contentIsDirectoryKind)
      },
      selectionMetadata(/*content*/) {
        return function() {};
        // let count = 0;
        // let total = 0;
        // if (this.ancestorCounts[content.id]) {
        //   count = this.ancestorCounts[content.id].count;
        //   total = this.ancestorCounts[content.id].total;
        // }
        // if (count) {
        //   return this.$tr('selectionInformation', {
        //     count,
        //     total,
        //   });
        // }
        // return '';
        // return function() {
        //   console.log('Dynamic function called');
        // };
      },
      addableContent() {
        // Content in the topic that can be added if 'Select All' is clicked
        const list = this.channels ? this.channels : this.bookmarksList;
        return list.filter(
          content => !this.contentIsDirectoryKind(content) && !this.contentIsInLesson(content)
        );
      },
      goBack() {
        return {
          name: PageNames.QUIZ_SECTION_EDITOR,
          params: {
            section_id: this.$route.params.section_id,
          },
        };
      },
      getBookmarksLink() {
        return {
          name: PageNames.BOOK_MARKED_RESOURCES,
          params: {
            section_id: this.$route.params.section_id,
          },
        };
      },
      channelsLink() {
        return this.selectionRootLink();
      },
    },

    watch: {
      workingResources(newVal, oldVal) {
        this.showResourcesDifferenceMessage(newVal.length - oldVal.length);
        this.debouncedSaveResources();
      },
    },

    beforeRouteUpdate(to, from, next) {
      console.log('beforeRouteUpdate', to, from);
      if (to.params.topic_id) {
        next(vm => {
          vm.updateResource();
        });
      }
    },

    beforeRouteLeave(to, from, next) {
      // Block the UI and show a notification in case last save takes too long
      this.isExiting = true;

      // If the working resources array hasn't changed at least once,
      // just exit without autosaving
      if (!this.resourcesChanged) {
        next();
        this.isExiting = false;
      } else {
        this.resourcesChanged = true;

        // Cancel any debounced calls
        this.debouncedSaveResources.cancel();
        this.saveLessonResources({
          lessonId: this.lessonId,
          resources: [...this.workingResources],
        })
          .then(() => {
            this.clearSnackbar();
            this.isExiting = false;
            next();
          })
          .catch(() => {
            this.showResourcesChangedError();
            this.isExiting = false;
            next(false);
          });
      }
    },
    methods: {
      /** @public */
      focusFirstEl() {
        this.$refs.textbox.focus();
      },
      // selectionMetadata(content) {
      //   if (content.kind === ContentNodeKinds.TOPIC) {
      //     const count = content.exercises.filter(exercise =>
      //       Boolean(this.selectedExercises[exercise.id])
      //     ).length;
      //     if (count === 0) {
      //       return '';
      //     }
      //     const total = content.exercises.length;
      //     return this.$tr('total_number', { count, total });
      //   }
      //   return '';
      // },
      lessonCardClicked() {
        this.showChannels = false;
      },
      contentLink(content) {
        if (!content.is_leaf) {
          return {
            name: PageNames.SELECT_FROM_RESOURCE,
            params: {
              topic_id: content.id,
              classId: this.$route.params.classId,
              section_id: this.$route.params.section_id,
            },
          };
        }

        return {}; // or return {} if you prefer an empty object
      },
      selectionRootLink() {
        return this.$router.getRoute(PageNames.SELECT_FROM_RESOURCE, {}, this.$route.query);
      },
      toggleSelected({ content, checked }) {
        if (checked) {
          this.addToSelectedResources(content);
        } else {
          this.removeFromSelectedResources([content]);
        }
      },
      toggleTopicInWorkingResources(isChecked) {
        if (isChecked) {
          this.addableContent.forEach(resource => {
            this.addToResourceCache({
              node: { ...resource },
            });
          });
          this.addToWorkingResources(this.addableContent);
        } else {
          this.removeFromSelectedResources(this.quizForge.channels.value);
        }
      },
      contentIsDirectoryKind({ is_leaf }) {
        return !is_leaf;
      },
      updateResource() {
        this.fetchTopicResources(this.$route.params.topic_id).then(resource => {
          console.log('fetchedTopicResources', resource);
          this.visibleResources.value = resource.contentList;
          //this.ancestors = resource.ancestors;
        });
      },
      topicListingLink({ topicId }) {
        return this.$router.getRoute(
          PageNames.SELECT_FROM_RESOURCE,
          { topicId },
          this.$route.query
        );
      },
      topicsLink(topicId) {
        return this.topicListingLink({ ...this.$route.params, topicId });
      },
    },
  };

</script>


<style scoped lang="scss">

  @import '~kolibri-design-system/lib/styles/definitions';

  .select-resource {
    margin-top: -4em;
  }

  .title-style {
    font-size: 1.4em;
    font-weight: 600;
  }

  .search-filters {
    margin-top: 24px;
  }

  .bookmark-container {
    display: flex;
    min-height: 141px;
    margin-bottom: 24px;
    border-radius: 2px;
    box-shadow: 0 1px 5px 0 #a1a1a1, 0 2px 2px 0 #e6e6e6, 0 3px 1px -2px #ffffff;
    transition: box-shadow 0.25s ease;
  }

  .mobile-bookmark-container {
    @extend %dropshadow-2dp;

    display: flex;
    max-width: 100%;
    min-height: 141px;
    margin: auto;
    margin-bottom: 24px;
    border-radius: 2px;

    .ease:hover {
      @extend %dropshadow-8dp;
      @extend %md-decelerate-func;

      transition: all $core-time;
    }
  }

  .mobile-bookmark-icon {
    left: 24px !important;
  }

  .mobile-text {
    margin-top: 20px;
    margin-left: 60px;
  }

  .bookmark-container:hover {
    box-shadow: 0 5px 5px -3px #a1a1a1, 0 8px 10px 1px #d1d1d1, 0 3px 14px 2px #d4d4d4;
  }

  .text {
    margin-left: 15rem;
  }

  .bottom-navigation {
    position: fixed;
    bottom: 0;
    width: 50%;
    padding: 10px;
    color: black;
    text-align: center;
    background-color: white;
  }

</style>
