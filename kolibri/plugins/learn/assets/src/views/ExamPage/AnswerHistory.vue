<template>

  <AccordionContainer
    :hideTopActions="true"
    :items="sections"
    :style="{ backgroundColor: $themeTokens.surface }"
  >
    <AccordionItem
      v-for="(section, index) in sections"
      :id="`section-questions-${index}`"
      :key="`section-questions-${index}`"
      :title="section.section_title"
      @focus="expand(index)"
    >
      <template #heading="{ title }">
        <h3 class="accordion-header">
          <KButton
            tabindex="0"
            appearance="basic-link"
            :style="accordionStyleOverrides"
            class="accordion-header-label"
            :aria-expanded="isExpanded(index)"
            :aria-controls="`section-question-panel-${index}`"
            @click="toggle(index)"
          >
            <KIcon
              class="dot"
              :icon="sectionQuestionsIcon(index)"
              :color="sectionQuestionsIconColor(index)"
            />
            <span>{{ title }}</span>
            <KIcon
              class="chevron-icon"
              :icon="(isExpanded(index)) ?
                'chevronUp' : 'chevronRight'"
            />
          </KButton>
        </h3>
      </template>

      <template #content>

        <div
          v-if="isExpanded(index)"
          class="spacing-items"
          :style="{
            backgroundColor: $themePalette.grey.v_100,
          }"
        >
          <span
            class="divider"
            :style="{ borderTop: `solid 1px ${$themeTokens.fineLine}` }"
          >
          </span>

          <div :aria-label="$tr('jumpToQuestion')" role="navigation">
            <ul class="history-list">
              <li
                v-for="(question, qIndex) in section.questions"
                :key="itemRef(question.item)"
                :ref="itemRef(question.item)"
                class="list-item"
              >
                <button
                  :class="buttonClass(question.item)"
                  :disabled="question.item === questionItem"
                  class="clickable"
                  @click="$emit('goToQuestion', question.item)"
                >
                  <KIcon
                    v-if="question.missing"
                    class="published"
                    icon="warning"
                    :color="$themePalette.yellow.v_1100"
                  />
                  <KIcon
                    v-else
                    class="dot"
                    :icon="isAnswered(question) ? 'unpublishedResource' : 'unpublishedChange'"
                    :color="
                      isAnswered(question) ? $themeTokens.progress : $themeTokens.textDisabled"
                  />
                  <div class="text">
                    {{ questionText(qIndex + 1) }}
                  </div>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </template>
    </AccordionItem>
  </AccordionContainer>

</template>


<script>

  import AccordionItem from 'kolibri-common/components/AccordionItem';
  import AccordionContainer from 'kolibri-common/components/AccordionContainer';
  import useAccordion from 'kolibri-common/components/useAccordion';
  import { toRefs } from '@vueuse/core';

  function isAboveContainer(element, container) {
    return element.offsetTop < container.scrollTop;
  }

  function isBelowContainer(element, container) {
    return element.offsetTop + element.offsetHeight > container.offsetHeight + container.scrollTop;
  }

  export default {
    name: 'AnswerHistory',
    components: { AccordionContainer, AccordionItem },
    setup(props) {
      const { sections } = toRefs(props);

      const { expand, isExpanded, toggle } = useAccordion(sections);

      return {
        expand,
        isExpanded,
        toggle,
      };
    },
    props: {
      currentQuestion: {
        type: Object,
        required: true,
      },
      sections: {
        type: Array,
        required: true,
      },
      pastattempts: {
        type: Array,
        required: true,
      },
      questionNumber: {
        type: Number,
        required: true,
      },
      questionItem: {
        type: String,
        required: true,
      },
      // hack to get access to the scrolling pane
      wrapperComponentRefs: {
        type: Object,
        required: true,
      },
    },
    computed: {
      currentSection() {
        return this.sections.find(section =>
          section.questions.map(q => q.item).includes(this.questionItem)
        );
      },
      sectionCompletionMap() {
        const answeredAttemptItems = this.pastattempts.filter(a => a.answer).map(a => a.item);
        return this.sections.reduce((acc, { questions }, index) => {
          acc[index] = questions
            .filter(q => answeredAttemptItems.includes(q.item))
            .map(q => q.item);

          return acc;
        }, {});
      },
      accordionStyleOverrides() {
        return {
          color: this.$themeTokens.text + '!important',
          textDecoration: 'none',
        };
      },
    },
    watch: {
      questionNumber() {
        // Expand the section that contains the current question if it's closed
        if (this.currentSection.questions.map(q => q.item).includes(this.questionItem)) {
          const index = this.sections.indexOf(this.currentSection);
          if (!this.isExpanded(index)) {
            this.expand(index);
          }
        }
        // If possible, scroll it into view
        const element = (this.$refs[this.itemRef(this.questionItem)] || [])[0];
        if (element && element.scrollIntoView && this.wrapperComponentRefs.questionListWrapper) {
          const container = this.wrapperComponentRefs.questionListWrapper.$el;
          if (isAboveContainer(element, container)) {
            element.scrollIntoView({ block: 'start', inline: 'nearest', behavior: 'smooth' });
          } else if (isBelowContainer(element, container)) {
            element.scrollIntoView({ block: 'end', inline: 'nearest', behavior: 'smooth' });
          }
        }
      },
    },
    created() {
      // This is done here because when I did it in setup() the linter said the prop was not
      // being used... so I moved it here and it's happy now.
      // Expand the section that contains the current question
      this.expand(
        this.sections.findIndex(section =>
          section.questions.map(q => q.item).includes(this.currentQuestion.item)
        )
      );
    },
    methods: {
      sectionQuestionsIconColor(index) {
        const answered = this.sectionCompletionMap[index].length;
        const total = this.sections[index].questions.length;
        if (answered === total) {
          return this.$themeTokens.progress;
        } else if (answered > 0) {
          return this.$themeTokens.progress;
        }
        return this.$themeTokens.textDisabled;
      },
      sectionQuestionsIcon(index) {
        const answered = this.sectionCompletionMap[index].length;
        const total = this.sections[index].questions.length;
        if (answered === total) {
          return 'unpublishedResource';
        } else if (answered > 0) {
          return 'unpublishedChange';
        }
        return 'unpublishedChange';
      },
      itemRef(item) {
        return `answer-history-item-${item}`;
      },
      questionText(num) {
        return this.$tr('question', { num });
      },
      isAnswered(question) {
        const attempt = this.pastattempts.find(attempt => attempt.item === question.item);
        return attempt && attempt.answer;
      },
      buttonClass(item) {
        if (this.questionItem === item) {
          return this.$computedClass({ backgroundColor: this.$themePalette.grey.v_100 });
        }
        return this.$computedClass({
          backgroundColor: this.$themeTokens.surface,
          ':hover': {
            backgroundColor: this.$themePalette.grey.v_100,
          },
        });
      },
    },
    $trs: {
      question: {
        message: 'Question { num, number, integer}',
        context:
          "In the report section, the 'Answer history' shows the learner if they have answered questions correctly or incorrectly.\n\nOnly translate 'Question'.",
      },
      jumpToQuestion: {
        message: 'Jump to question',
        context:
          'A label for the section of the page that contains all questions as clickable links',
      },
    },
  };

</script>


<style lang="scss" scoped>

  @import '~kolibri-design-system/lib/styles/definitions';

  .history-list {
    max-height: inherit;
    padding-left: 0;
    margin: 0;
    margin-top: 16px;
    list-style-type: none;
  }

  .list-item {
    margin-bottom: 4px;
  }

  .clickable {
    @extend %md-decelerate-func;

    position: relative;
    display: block;
    width: 100%;
    text-align: left;
    cursor: pointer;
    user-select: none;
    border: 0;
    border-radius: 4px;
    outline-offset: -2px;
    transition: background-color $core-time;
  }

  .dot {
    position: absolute;
    top: 18px;
    left: 16px;
  }

  .text {
    margin: 16px;
    margin-left: 48px;
  }

  .accordion-header {
    position: relative;
    display: flex;
    align-items: center;
    padding: 0;
    margin: 0;
    font-size: 1rem;
    line-height: 1.5;
    text-align: left;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
  }

  .accordion-header-label {
    display: block;
    width: calc(100% - 1em);
    height: 100%;
    padding: 1em;

    span {
      margin-left: 2em;
    }
  }

  .chevron-icon {
    position: absolute;
    top: 50%;
    right: 0.5em;
    vertical-align: middle;
    transform: translateY(-50%);
  }

</style>
